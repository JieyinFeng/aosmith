---
title: Custom contrasts in emmeans
author: Ariel Muldoon
date: '2019-04-15'
slug: custom-contrasts-in-emmeans
categories:
  - r
  - statistics
tags:
  - analysis
  - teaching
draft: TRUE
description: "One of the nice things about emmeans is that you can build custom comparisons for any groups or combinations of groups, which I show how to do in this post."
---



<p>Following up on a <a href="https://aosmith.rbind.io/2019/03/25/getting-started-with-emmeans/">previous post</a> introducing the basic usage of package <strong>emmeans</strong> for doing post hoc comparisons, here I’ll talk specifically about building custom comparisons (aka <em>contrasts</em>). These are comparisons that aren’t encompassed by some of the built-in functions in the package. Remember that you can explore the available built-in functions for doing comparisons listed in the documentation for <code>?"contrast-methods"</code>.</p>
<div id="r-packages" class="section level1">
<h1>R packages</h1>
<p>I will load <strong>magrittr</strong> for the pipe in addition to <strong>emmeans</strong>.</p>
<pre class="r"><code>library(emmeans) # v. 1.3.3
library(magrittr) # v. 1.5</code></pre>
</div>
<div id="reasons-for-custom-comparisons" class="section level1">
<h1>Reasons for custom comparisons</h1>
<p>There are a variety of reasons you might need to custom comparisons instead of the built in ones. One common scenario that I see a lot having a single control group for multiple factors, so the factors aren’t perfectly crossed. This comes up, e.g., when doing experiments involving applying different substances (like fertilizers) at varying rates. One factor is the different substances applied and the other is the application rate. However, the control is applying nothing or water or something. There aren’t different “rates” of the control to apply, so there is a single control group for both factors.</p>
<p>Rather than trying to fit a model with multiple factors, focusing on main effects and the interaction, such data can be analyzed with a <em>simple effects</em> model. This is where the factors of interest have been combined into one. Post hoc comparisons can be used to estimate the overall effects of the individual factors of interest.</p>
</div>
<div id="the-dataset-and-model" class="section level1">
<h1>The dataset and model</h1>
<p>I’ve made a small dataset to use as an example. The response variable is <code>resp</code> and the two factors of interest have been combined into a single factor with 5 levels: “A.1”, “A.2”, “B.1”, “B.2”, and “control”. One factor, which I’m thinking of as the “substance” factor, is represented by “A” and “B” (and the control). The second, the “rate” factor, is represnted by “1” and “2”.</p>
<pre class="r"><code>dat = structure(list(f1.f2 = structure(c(1L, 1L, 1L, 1L, 1L, 2L, 2L, 
2L, 2L, 2L, 3L, 3L, 3L, 3L, 3L, 4L, 4L, 4L, 4L, 4L, 5L, 5L, 5L, 
5L, 5L), .Label = c(&quot;A.1&quot;, &quot;A.2&quot;, &quot;B.1&quot;, &quot;B.2&quot;, &quot;control&quot;), class = &quot;factor&quot;),
    resp = c(1.5, 0.9, 2.1, -0.4, 2.1, -0.5, -1, 0.1, 1, 0.6, 
    3.3, 1.6, 0.8, 3.2, 2.2, 0.3, 2.6, 2.5, 1.5, 3.1, 1.4, 2.7, 
    2.8, 4.5, 2.1)), row.names = c(NA, -25L), class = &quot;data.frame&quot;)
str(dat)</code></pre>
<pre><code># &#39;data.frame&#39;: 25 obs. of  2 variables:
#  $ f1.f2: Factor w/ 5 levels &quot;A.1&quot;,&quot;A.2&quot;,&quot;B.1&quot;,..: 1 1 1 1 1 2 2 2 2 2 ...
#  $ resp : num  1.5 0.9 2.1 -0.4 2.1 -0.5 -1 0.1 1 0.6 ...</code></pre>
<p>I will use a simple, linear model for analysis.</p>
<pre class="r"><code>fit1 = lm(resp ~ f1.f2, data = dat)</code></pre>
</div>
<div id="treatment-vs-control-comparisons" class="section level1">
<h1>Treatment vs control comparisons</h1>
<p>This sort of simple effects model makes it easy to get comparisons for each factor combination vs the control group with <code>emmeans()</code>. I’ll use <code>trt.vs.ctrlk</code> here for the comparisons since the control is the last level of the factor.</p>
<pre class="r"><code>emmeans(fit1, specs = trt.vs.ctrlk ~ f1.f2)</code></pre>
<pre><code># $emmeans
#  f1.f2   emmean    SE df lower.CL upper.CL
#  A.1       1.24 0.466 20    0.267     2.21
#  A.2       0.04 0.466 20   -0.933     1.01
#  B.1       2.22 0.466 20    1.247     3.19
#  B.2       2.00 0.466 20    1.027     2.97
#  control   2.70 0.466 20    1.727     3.67
# 
# Confidence level used: 0.95 
# 
# $contrasts
#  contrast      estimate   SE df t.ratio p.value
#  A.1 - control    -1.46 0.66 20 -2.214  0.1230 
#  A.2 - control    -2.66 0.66 20 -4.033  0.0024 
#  B.1 - control    -0.48 0.66 20 -0.728  0.8403 
#  B.2 - control    -0.70 0.66 20 -1.061  0.6548 
# 
# P value adjustment: dunnettx method for 4 tests</code></pre>
</div>
<div id="getting-started-building-custom-contrasts" class="section level1">
<h1><a href="#getting-started-building-custom%20contrasts">Getting started building custom contrasts</a></h1>
<p>But what if we want to compare the “A” group to the “B” group regardless of the application rate? This is where we are going to need to set up a custom contrast. Before I get to that, though, I’m going to walk through a simpler example on how this works.</p>
<p>Custom contrasts are based on the estimated marginal means output from <code>emmeans()</code>. The first step is to calculate these so we have them to work with.</p>
<pre class="r"><code>emm1 = emmeans(fit1, specs = ~ f1.f2)
emm1</code></pre>
<pre><code>#  f1.f2   emmean    SE df lower.CL upper.CL
#  A.1       1.24 0.466 20    0.267     2.21
#  A.2       0.04 0.466 20   -0.933     1.01
#  B.1       2.22 0.466 20    1.247     3.19
#  B.2       2.00 0.466 20    1.027     2.97
#  control   2.70 0.466 20    1.727     3.67
# 
# Confidence level used: 0.95</code></pre>
<p>Let’s say we want to compare mean <code>resp</code> of the “A.2” group to the “B.2” group. We’ll need to pull out those specific means from the <code>emmeans</code> above to do this comparison. We <em>pull out</em> values by assigning the means we want as 1’s and the means we don’t want as 0’s.</p>
<p>To pull out the mean of “A.2” above we will make a vector with 5 values in it. The second value will be a 1, since the mean of “A.2” is in the second row. All the other values will be 0.</p>
<pre class="r"><code>A2 = c(0, 1, 0, 0, 0)</code></pre>
<p>Simlarly, to pull out the mean of “B.2” we’ll have a vector of 5 values with a 1 as the fourth value. In the output above the “B.2.” group is on the fourth row.</p>
<pre class="r"><code>B2 = c(0, 0, 0, 1, 0)</code></pre>
<p>When building custom contrasts via vectors like this, the vectors will always be the same length as the number of rows in the <code>emmeans</code> output. I always calculate the <code>emmeans</code> prior to building the vectors so I know the number of rows and order the groups are in in the output.</p>
</div>
<div id="using-the-contrast-function" class="section level1">
<h1>Using the contrast() function</h1>
<p>Once we have the vectors that represent the means we are interested in comparing, we do the comparisons via the <code>contrast()</code> function. Since we are interested in a <em>difference</em> in mean response, we’ll take the difference between the vectors of means. Taking the difference can be done inside or outside <code>contrast()</code>. In this example I’m doing it inside.</p>
<p>The <code>contrast()</code> function takes the <code>emmGrid</code> object <code>emm1</code> as the first argument. We give the comparisons we want to do as a list. Here I’m subtracting B2 from A2.</p>
<pre class="r"><code>contrast(emm1, method = list(A2 - B2) )</code></pre>
<pre><code>#  contrast          estimate   SE df t.ratio p.value
#  c(0, 1, 0, -1, 0)    -1.96 0.66 20 -2.972  0.0075</code></pre>
</div>
<div id="using-named-lists-for-better-output" class="section level1">
<h1>Using named lists for better output</h1>
<p>The name in the output above isn’t very helpful. Using a named list for <code>method</code> will help.</p>
<pre class="r"><code>contrast(emm1, method = list(&quot;A2 minus B2&quot; = A2 - B2) )</code></pre>
<pre><code>#  contrast    estimate   SE df t.ratio p.value
#  A2 minus B2    -1.96 0.66 20 -2.972  0.0075</code></pre>
</div>
<div id="an-alternative-for-simple-comparisons" class="section level1">
<h1>An alternative for simple comparisons</h1>
<p>Note that I didn’t need to do a custom contrast to do this comparison. I could have gotten the comparison I wanted by using the <code>at</code> argument in <code>emmeans()</code> and choosing just the groups I was interested in.</p>
<pre class="r"><code>emmeans(fit1, specs = pairwise ~ f1.f2, 
         at = list(f1.f2 = c(&quot;A.2&quot;, &quot;B.2&quot;) ) )</code></pre>
<pre><code># $emmeans
#  f1.f2 emmean    SE df lower.CL upper.CL
#  A.2     0.04 0.466 20   -0.933     1.01
#  B.2     2.00 0.466 20    1.027     2.97
# 
# Confidence level used: 0.95 
# 
# $contrasts
#  contrast  estimate   SE df t.ratio p.value
#  A.2 - B.2    -1.96 0.66 20 -2.972  0.0075</code></pre>
</div>
<div id="multiple-custom-contrasts-at-once" class="section level1">
<h1><a href="#multiple-custom-contrasts-at-once">Multiple custom contrasts at once</a></h1>
<p>Multiple custom contrasts can be done at one time by adding to the list. I’ll “fake” this by doing the example comparison twice, changing only which group is subtracted.</p>
<pre class="r"><code>contrast(emm1, method = list(&quot;A2 minus B2&quot; = A2 - B2,
                             &quot;B2 minus A2&quot; = B2 - A2) )</code></pre>
<pre><code>#  contrast    estimate   SE df t.ratio p.value
#  A2 minus B2    -1.96 0.66 20 -2.972  0.0075 
#  B2 minus A2     1.96 0.66 20  2.972  0.0075</code></pre>
<p>Doing multiple comparisons at once means a multiple comparisons adjustment can be done as needed. In addition, we can use the <code>confint()</code> function do get confidence intervals of comparisons.</p>
<p>I’ll play around here by adding a multivariate t adjustment via <code>adjust = "mvt"</code> and then get confidence intervals for the comparisons.</p>
<pre class="r"><code>contrast(emm1, method = list(&quot;A2 minus B2&quot; = A2 - B2,
                             &quot;B2 minus A2&quot; = B2 - A2),
         adjust = &quot;mvt&quot;) %&gt;%
  confint()</code></pre>
<pre><code>#  contrast    estimate   SE df lower.CL upper.CL
#  A2 minus B2    -1.96 0.66 20   -3.336   -0.584
#  B2 minus A2     1.96 0.66 20    0.584    3.336
# 
# Confidence level used: 0.95 
# Conf-level adjustment: mvt method for 2 estimates</code></pre>
</div>
<div id="more-complicated-custom-contrasts" class="section level1">
<h1>More complicated custom contrasts</h1>
<p>Let’s get back to the original comparison I proposed, which was to estimate the overall effect of “A” vs “B”. This is a “main effect” comparison, so I want to average over the effect of rate to talk about the overall effect of the substance factor levels.</p>
<p>I’ll need to pull out the means for all four non-control factor levels. I’ll print <code>emm1</code> again so I remember the order.</p>
<pre class="r"><code>emm1</code></pre>
<pre><code>#  f1.f2   emmean    SE df lower.CL upper.CL
#  A.1       1.24 0.466 20    0.267     2.21
#  A.2       0.04 0.466 20   -0.933     1.01
#  B.1       2.22 0.466 20    1.247     3.19
#  B.2       2.00 0.466 20    1.027     2.97
#  control   2.70 0.466 20    1.727     3.67
# 
# Confidence level used: 0.95</code></pre>
<p>I need to pull out each of the first four means to do the comparison. If these vectors are every really long I sometimes use <code>rep()</code> to put all the 0 values in.</p>
<pre class="r"><code>A1 = c(1, 0, 0, 0, 0)
A2 = c(0, 1, 0, 0, 0)
B1 = c(0, 0, 1, 0, 0)
B2 = c(0, 0, 0, 1, 0)</code></pre>
<p>The vectors I made represent means for combinations of substance and rate. I want to get the overall substance group means. This involves <em>averaging over</em> the rate. As in literally taking the average of, e.g., <code>A1</code> and <code>A2</code> to get the overall <code>A</code> mean.</p>
<pre class="r"><code>Aoverall = (A1 + A2)/2
Boverall = (B1 + B2)/2</code></pre>
<p>Now that the overall means are calculated we can do comparison of mean <code>resp</code> of the <code>A</code> group vs <code>B</code> group overall in <code>contrast()</code> the same way we used it above.</p>
<pre class="r"><code>contrast(emm1, method = list(&quot;A minus B&quot; = Aoverall - Boverall) ) </code></pre>
<pre><code>#  contrast  estimate    SE df t.ratio p.value
#  A minus B    -1.47 0.466 20 -3.152  0.0050</code></pre>
<p>All other custom contrasts are built in this same basic way. You can also build your own contrast functions if there is a custom contrast you do all the time. See the <a href="https://cran.r-project.org/web/packages/emmeans/vignettes/comparisons.html#linfcns">custom contrasts section</a> of the <strong>emmeans</strong> vignette for more info.</p>
</div>
